var FCKDragTableHandler={"_DragState":0,"_LeftCell":null,"_RightCell":null,"_MouseMoveMode":0,"_ResizeBar":null,"_OriginalX":null,"_MinimumX":null,"_MaximumX":null,"_LastX":null,"_TableMap":null,"_doc":document,"_IsInsideNode":function(w,A,B){var C=FCKTools.GetWindowPosition(w,A);var D=C.x;var E=C.y;var F=parseInt(D,10)+parseInt(A.offsetWidth,10);var G=parseInt(E,10)+parseInt(A.offsetHeight,10);if (B.x>=D&&B.x<=F&&B.y>=E&&B.y<=G) return true;return false;},"_GetBorderCells":function(w,A,B,C){var D=[];for (var i=0;i<A.rows.length;i++){var r=A.rows[i];for (var j=0;j<r.cells.length;j++) D.push(r.cells[j]);};if (D.length<1) return null;var E=null;var F=null;var G=null;var H=null;var I=null;for (var i=0;i<D.length;i++){var J=FCKTools.GetWindowPosition(w,D[i]);var K=J.x+parseInt(D[i].clientWidth,10);var L=C.x-K;var M=C.y-(J.y+(D[i].clientHeight/2));if (E==null||(Math.abs(L)<=Math.abs(E)&&(G==null||Math.abs(M)<=Math.abs(G)))){E=L;G=M;H=D[i];}};var N=H.parentNode.rowIndex;var O=FCKTableHandler._GetCellIndexSpan(B,N,H);var P=isNaN(H.colSpan)?1:H.colSpan;I=B[N][O+P];if (!I) return null;F=C.x-FCKTools.GetWindowPosition(w,I).x;if (F<0&&E<0&&E<-2) return null;if (F>0&&E>0&&F>3) return null;return { "leftCell":H,"rightCell":I };},"_GetResizeBarPosition":function(){var A=FCKTools.GetElementAscensor(this._RightCell,"tr");return FCKTableHandler._GetCellIndexSpan(this._TableMap,A.rowIndex,this._RightCell);},"_ResizeBarMouseDownListener":function(A){if (FCKDragTableHandler._LeftCell) FCKDragTableHandler._MouseMoveMode=1;if (FCKBrowserInfo.IsIE) FCKDragTableHandler._ResizeBar.filters.item("DXImageTransform.Microsoft.Alpha").opacity=50;else FCKDragTableHandler._ResizeBar.style.opacity=0.5;FCKDragTableHandler._OriginalX=A.clientX;var B=FCKDragTableHandler._GetResizeBarPosition();var C=FCKDragTableHandler._GetIframeOffset();var D=FCKTools.GetElementAscensor(FCKDragTableHandler._LeftCell,"table");var E=null;var F=null;for (var r=0;r<FCKDragTableHandler._TableMap.length;r++){var G=FCKDragTableHandler._TableMap[r][B-1];var H=FCKDragTableHandler._TableMap[r][B];var I=FCKTools.GetWindowPosition(FCK.EditorWindow,G);var J=FCKTools.GetWindowPosition(FCK.EditorWindow,H);var K=FCKDragTableHandler._GetCellPadding(D,G);var L=FCKDragTableHandler._GetCellPadding(D,H);if (E==null||I.x+K>E) E=I.x+K;if (F==null||J.x+H.clientWidth-L<F) F=J.x+H.clientWidth-L;};FCKDragTableHandler._MinimumX=E+C.x;FCKDragTableHandler._MaximumX=F+C.x;FCKDragTableHandler._LastX=null;if (A.preventDefault) A.preventDefault();else A.returnValue=false;},"_ResizeBarMouseUpListener":function(A){FCKDragTableHandler._MouseMoveMode=0;FCKDragTableHandler._HideResizeBar();if (FCKDragTableHandler._LastX==null) return;var B=FCKDragTableHandler._LastX-FCKDragTableHandler._OriginalX;var C=FCKTools.GetElementAscensor(FCKDragTableHandler._LeftCell,"table");var D=[];var E=FCKDragTableHandler._TableMap;for (var i=0;i<E.length;i++){for (var j=0;j<E[i].length;j++){var F=E[i][j];var G=FCKDragTableHandler._GetCellWidth(C,F);var H=isNaN(F.colSpan)?1:F.colSpan;if (D.length<=j) D.push({ 'width':G/H,'colSpan':H });else{var I=D[j];if (I.colSpan>H){I.width=G/H;I.colSpan=H;}}}};colIndex=FCKDragTableHandler._GetResizeBarPosition();colIndex--;D[colIndex].width+=B;D[colIndex+1].width-=B;for (var r=0;r<C.rows.length;r++){var J=C.rows.item(r);for (var c=0;c<J.cells.length;c++){var F=J.cells.item(c);F.width="";F.style.width="";}};var L=C.getElementsByTagName("col");for (var i=L.length-1;i>=0;i--) L[i].parentNode.removeChild(L[i]);var M=[];for (var i=0;i<E.length;i++){for (var j=0;j<E[i].length;j++){var F=E[i][j];if (F._Processed) continue;if (E[i][j-1]!=F) F.width=D[j].width;else F.width=parseInt(F.width,10)+parseInt(D[j].width,10);if (E[i][j+1]!=F){M.push(F);F._Processed=true;}}};for (var i=0;i<M.length;i++){if (FCKBrowserInfo.IsIE) M[i].removeAttribute('_Processed');else delete M[i]._Processed;};FCKDragTableHandler._LastX=null;},"_ResizeBarMouseMoveListener":function(A){if (FCKDragTableHandler._MouseMoveMode==0) return FCKDragTableHandler._MouseFindHandler(FCK,A);else return FCKDragTableHandler._MouseDragHandler(FCK,A);},"_GetCellPadding":function(A,B){var C=parseInt(A.cellPadding,10)*2;var D=null;if (typeof(window.getComputedStyle)=="function"){var E=window.getComputedStyle(B,null);D=parseInt(E.getPropertyValue("padding-left"),10)+parseInt(E.getPropertyValue("padding-right"),10);}else D=parseInt(B.currentStyle.paddingLeft,10)+parseInt (B.currentStyle.paddingRight,10);var F=B.style.padding;if (isFinite(F)) D=parseInt(F,10)*2;else{F=B.style.paddingLeft;if (isFinite(F)) D=parseInt(F,10);F=B.style.paddingRight;if (isFinite(F)) D+=parseInt(F,10);};C=parseInt(C,10);D=parseInt(D,10);if (isNaN(C)) C=0;if (isNaN(D)) D=0;return Math.max(C,D);},"_GetCellWidth":function(A,B){var C=B.clientWidth;if (isNaN(C)) C=0;return C-this._GetCellPadding(A,B);},"MouseMoveListener":function(A,B){if (FCKDragTableHandler._MouseMoveMode==0) return FCKDragTableHandler._MouseFindHandler(A,B);else return FCKDragTableHandler._MouseDragHandler(A,B);},"_MouseFindHandler":function(A,B){if (A.MouseDownFlag) return;var C=B.srcElement||B.target;try{if (!C||C.nodeType!=1){this._HideResizeBar();return;}}catch (e){this._HideResizeBar();return;};var D=B.clientX;var E=B.clientY;if (FCKTools.GetElementDocument(C)==document){var F=this._GetIframeOffset();D-=F.x;E-=F.y;};if (this._ResizeBar&&this._LeftCell){var G=FCKTools.GetWindowPosition(A.EditorWindow,this._LeftCell);var H=FCKTools.GetWindowPosition(A.EditorWindow,this._RightCell);var I=D-(G.x+this._LeftCell.clientWidth);var J=D-H.x;var K=false;if (J>=0&&I<=0) K=true;else if (I>0&&J<=3) K=true;else if (J<0&&I>=-2) K=true;if (K){this._ShowResizeBar(A.EditorWindow,FCKTools.GetElementAscensor(this._LeftCell,"table"),{ "x":D,"y":E });return;}};var L=C.tagName.toLowerCase();if (L!="table"&&L!="td"&&L!="th"){if (this._LeftCell) this._LeftCell=this._RightCell=this._TableMap=null;this._HideResizeBar();return;};C=FCKTools.GetElementAscensor(C,"table");var M=FCKTableHandler._CreateTableMap(C);var N=this._GetBorderCells(A.EditorWindow,C,M,{ "x":D,"y":E });if (N==null){if (this._LeftCell) this._LeftCell=this._RightCell=this._TableMap=null;this._HideResizeBar();}else{this._LeftCell=N["leftCell"];this._RightCell=N["rightCell"];this._TableMap=M;this._ShowResizeBar(A.EditorWindow,FCKTools.GetElementAscensor(this._LeftCell,"table"),{ "x":D,"y":E });}},"_MouseDragHandler":function(A,B){var C={ "x":B.clientX,"y":B.clientY };var D=B.srcElement||B.target;if (FCKTools.GetElementDocument(D)==A.EditorDocument){var E=this._GetIframeOffset();C.x+=E.x;C.y+=E.y;};if (C.x>=this._MaximumX-5) C.x=this._MaximumX-5;if (C.x<=this._MinimumX+5) C.x=this._MinimumX+5;var F=C.x+FCKTools.GetScrollPosition(window).X;this._ResizeBar.style.left=(F-this._ResizeBar.offsetWidth/2)+"px";this._LastX=C.x;},"_ShowResizeBar":function(w,A,B){if (this._ResizeBar==null){this._ResizeBar=this._doc.createElement("div");var C=this._ResizeBar;var D={ 'position':'absolute','cursor':'e-resize' };if (FCKBrowserInfo.IsIE) D.filter="progid:DXImageTransform.Microsoft.Alpha(opacity=10,enabled=true)";else D.opacity=0.10;FCKDomTools.SetElementStyles(C,D);this._avoidStyles(C);C.setAttribute('_fcktemp',true);this._doc.body.appendChild(C);FCKTools.AddEventListener(C,"mousemove",this._ResizeBarMouseMoveListener);FCKTools.AddEventListener(C,"mousedown",this._ResizeBarMouseDownListener);FCKTools.AddEventListener(document,"mouseup",this._ResizeBarMouseUpListener);FCKTools.AddEventListener(FCK.EditorDocument,"mouseup",this._ResizeBarMouseUpListener);var E=this._doc.createElement("img");E.setAttribute('_fcktemp',true);E.border=0;E.src=FCKConfig.BasePath+"images/spacer.gif";E.style.position="absolute";C.appendChild(E);var F=function(R){if (R.preventDefault) R.preventDefault();else R.returnValue=false;};FCKTools.AddEventListener(E,"dragstart",F);FCKTools.AddEventListener(E,"selectstart",F);};var C=this._ResizeBar;var H=this._GetIframeOffset();var I=this._GetTablePosition(w,A);var J=A.offsetHeight;var K=H.y+I.y;if (I.y<0){J+=I.y;K-=I.y;};var L=parseInt(A.border,10);if (isNaN(L)) L=0;var M=parseInt(A.cellSpacing,10);if (isNaN(M)) M=0;var N=Math.max(L+100,M+100);var D={'top':K+'px','height':J+'px','width':N+'px','left':(H.x+B.x+FCKTools.GetScrollPosition(w).X-N/2)+'px'};if (FCKBrowserInfo.IsIE) C.filters.item("DXImageTransform.Microsoft.Alpha").opacity=10;else D.opacity=0.1;FCKDomTools.SetElementStyles(C,D);var E=C.getElementsByTagName("img")[0];FCKDomTools.SetElementStyles(E,{width:C.offsetWidth+'px',height:J+'px'});N=Math.max(L,M,3);var Q=null;if (C.getElementsByTagName("div").length<1){Q=this._doc.createElement("div");this._avoidStyles(Q);Q.setAttribute('_fcktemp',true);C.appendChild(Q);}else Q=C.getElementsByTagName("div")[0];FCKDomTools.SetElementStyles(Q,{position:'absolute',backgroundColor:'blue',width:N+'px',height:J+'px',left:'50px',top:'0px'});},"_HideResizeBar":function(){if (this._ResizeBar) FCKDomTools.SetElementStyles(this._ResizeBar,{top:'-100000px',left:'-100000px'});},"_GetIframeOffset":function (){return FCKTools.GetDocumentPosition(window,FCK.EditingArea.IFrame);},"_GetTablePosition":function (w,A){return FCKTools.GetWindowPosition(w,A);},"_avoidStyles":function(A){FCKDomTools.SetElementStyles(A,{padding:'0',backgroundImage:'none',border:'0'});},"Reset":function(){FCKDragTableHandler._LeftCell=FCKDragTableHandler._RightCell=FCKDragTableHandler._TableMap=null;}};FCK.Events.AttachEvent("OnMouseMove",FCKDragTableHandler.MouseMoveListener);FCK.Events.AttachEvent("OnAfterSetHTML",FCKDragTableHandler.Reset);
